#!/usr/bin/env bash
set -euo pipefail

STATE_DIR="${DOBBY_STATE_DIR:-/media/zen/AI/zenny-operator/state}"

usage() {
  cat <<USAGE
zenny - minimal approval-gated job runner

Env:
  DOBBY_STATE_DIR   (default: /media/zen/AI/zenny-operator/state)

Commands:
  zenny status
  zenny jobs list
  zenny jobs new <id> <title>
  zenny jobs approve <id>
  zenny jobs done <id>
  zenny run <id>               (creates evidence bundle; does not execute)

Bundles:
  zenny bundle list <id>
  zenny bundle plan <bundle_dir>
  zenny bundle cmd  <bundle_dir>
  zenny bundle arm  <bundle_dir>   (creates EXECUTE_OK=1 file)
  zenny bundle exec <bundle_dir>   (runs commands.sh only if armed)

Notes:
- No secrets in artifacts/logs.
- Execution is opt-in and requires arming a specific bundle.
USAGE
}

must_state() {
  if [ ! -d "$STATE_DIR" ]; then
    echo "❌ DOBBY_STATE_DIR not found: $STATE_DIR" >&2
    exit 1
  fi
  mkdir -p "$STATE_DIR"/{jobs/{inbox,proposed,approved,running,done,failed},artifacts/{bundles,reports,patches},logs/runs}
}

now_ts() { date +%F_%H%M%S; }

cmd_status() {
  must_state
  echo "STATE_DIR=$STATE_DIR"
  for d in inbox proposed approved running done failed; do
    c=$(find "$STATE_DIR/jobs/$d" -maxdepth 1 -type f 2>/dev/null | wc -l | tr -d ' ')
    echo "jobs/$d: $c"
  done
}

cmd_jobs_list() {
  must_state
  for d in inbox proposed approved running done failed; do
    echo "== $d =="
    ls -1 "$STATE_DIR/jobs/$d" 2>/dev/null || true
    echo
  done
}

cmd_jobs_new() {
  must_state
  local id="${1:-}"; shift || true
  local title="${*:-}"
  if [ -z "$id" ] || [ -z "$title" ]; then
    echo "❌ usage: zenny jobs new <id> <title>" >&2
    exit 1
  fi
  local f="$STATE_DIR/jobs/inbox/${id}.md"
  if [ -e "$f" ]; then
    echo "❌ job already exists: $f" >&2
    exit 1
  fi
  cat > "$f" <<MD
# Job ${id} — ${title}

Goal:

Rules:
- Propose only unless approved.
- No marketplace installs.
- No secrets in logs/artifacts.

Deliverables:

Notes:
MD
  echo "✅ created: $f"
}

find_job_src() {
  local id="$1"
  local src=""
  for d in inbox proposed approved running done failed; do
    if [ -f "$STATE_DIR/jobs/$d/${id}.md" ]; then
      src="$STATE_DIR/jobs/$d/${id}.md"
      break
    fi
  done
  echo "$src"
}

cmd_jobs_approve() {
  must_state
  local id="${1:-}"
  if [ -z "$id" ]; then
    echo "❌ usage: zenny jobs approve <id>" >&2
    exit 1
  fi
  local src=""
  for d in inbox proposed; do
    if [ -f "$STATE_DIR/jobs/$d/${id}.md" ]; then
      src="$STATE_DIR/jobs/$d/${id}.md"
      break
    fi
  done
  if [ -z "$src" ]; then
    echo "❌ job not found in inbox/proposed: ${id}.md" >&2
    exit 1
  fi
  mv "$src" "$STATE_DIR/jobs/approved/${id}.md"
  echo "✅ approved: $id"
}

cmd_jobs_done() {
  must_state
  local id="${1:-}"
  if [ -z "$id" ]; then
    echo "❌ usage: zenny jobs done <id>" >&2
    exit 1
  fi
  local src="$STATE_DIR/jobs/approved/${id}.md"
  if [ ! -f "$src" ]; then
    echo "❌ job not found in approved: ${id}.md" >&2
    exit 1
  fi
  mv "$src" "$STATE_DIR/jobs/done/${id}.md"
  echo "✅ done: $id"
}

bundle_dir_from_arg() {
  local b="${1:-}"
  if [ -z "$b" ]; then
    echo "❌ bundle dir required" >&2
    exit 1
  fi
  if [[ "$b" != /* ]]; then
    b="$PWD/$b"
  fi
  echo "$b"
}

cmd_run() {
  must_state
  local id="${1:-}"
  if [ -z "$id" ]; then
    echo "❌ usage: zenny run <id>" >&2
    exit 1
  fi

  local job="$STATE_DIR/jobs/approved/${id}.md"
  if [ ! -f "$job" ]; then
    echo "⛔ REFUSED: job not approved. Put ${id}.md in jobs/approved/ first." >&2
    exit 2
  fi

  local ts; ts="$(now_ts)"
  local bundle="$STATE_DIR/artifacts/bundles/${id}-${ts}"
  mkdir -p "$bundle"/{outputs,inputs}
  cp "$job" "$bundle/job.md"

  cat > "$bundle/README.md" <<TXT
Evidence bundle: ${id}-${ts}

This bundle is the unit of execution.
- plan.md: human-readable plan
- commands.sh: generated commands (optional)
- EXECUTE_OK: required to run commands.sh
- outputs/: logs and command outputs
TXT

  # stub plan + commands
  cat > "$bundle/plan.md" <<'MD'
# Plan (stub)

Describe:
- what will change
- why
- safety checks
- verification steps
MD

  cat > "$bundle/commands.sh" <<'SH'
#!/usr/bin/env bash
set -euo pipefail
# Commands go here. Keep them idempotent when possible.
echo "No commands yet."
SH
  chmod +x "$bundle/commands.sh"

  echo "✅ created evidence bundle: $bundle"
  echo "Next:"
  echo "  zenny bundle plan $bundle   # edit/confirm plan"
  echo "  zenny bundle cmd  $bundle   # edit commands"
  echo "  zenny bundle arm  $bundle   # require explicit arming"
  echo "  zenny bundle exec $bundle   # execute commands.sh (armed only)"
}

cmd_bundle_list() {
  must_state
  local id="${1:-}"
  if [ -z "$id" ]; then
    echo "❌ usage: zenny bundle list <id>" >&2
    exit 1
  fi
  ls -1 "$STATE_DIR/artifacts/bundles" | rg "^${id}-" || true
}

cmd_bundle_plan() {
  must_state
  local b; b="$(bundle_dir_from_arg "${1:-}")"
  if [ ! -d "$b" ]; then
    echo "❌ bundle not found: $b" >&2
    exit 1
  fi
  ${EDITOR:-nano} "$b/plan.md"
}

cmd_bundle_cmd() {
  must_state
  local b; b="$(bundle_dir_from_arg "${1:-}")"
  if [ ! -d "$b" ]; then
    echo "❌ bundle not found: $b" >&2
    exit 1
  fi
  ${EDITOR:-nano} "$b/commands.sh"
  chmod +x "$b/commands.sh" || true
}

cmd_bundle_arm() {
  must_state
  local b; b="$(bundle_dir_from_arg "${1:-}")"
  if [ ! -d "$b" ]; then
    echo "❌ bundle not found: $b" >&2
    exit 1
  fi
  echo "EXECUTE_OK=1" > "$b/EXECUTE_OK"
  echo "✅ armed bundle: $b"
}

cmd_bundle_exec() {
  must_state
  local b; b="$(bundle_dir_from_arg "${1:-}")"
  if [ ! -d "$b" ]; then
    echo "❌ bundle not found: $b" >&2
    exit 1
  fi
  if [ ! -f "$b/EXECUTE_OK" ]; then
    echo "⛔ REFUSED: bundle not armed. Run: zenny bundle arm $b" >&2
    exit 2
  fi

  local out="$b/outputs/run-$(now_ts).log"
  echo "▶ executing $b/commands.sh"
  echo "log: $out"
  (cd "$b" && ./commands.sh) 2>&1 | tee "$out"
  echo "✅ done"
}

main() {
  case "${1:-}" in
    status) shift; cmd_status "$@";;
    jobs)
      shift
      case "${1:-}" in
        list) shift; cmd_jobs_list "$@";;
        new) shift; cmd_jobs_new "$@";;
        approve) shift; cmd_jobs_approve "$@";;
        done) shift; cmd_jobs_done "$@";;
        *) usage; exit 1;;
      esac
      ;;
    run) shift; cmd_run "$@";;
    bundle)
      shift
      case "${1:-}" in
        list) shift; cmd_bundle_list "$@";;
        plan) shift; cmd_bundle_plan "$@";;
        cmd) shift; cmd_bundle_cmd "$@";;
        arm) shift; cmd_bundle_arm "$@";;
        exec) shift; cmd_bundle_exec "$@";;
        *) usage; exit 1;;
      esac
      ;;
    -h|--help|"") usage;;
    *) echo "❌ unknown command: ${1:-}" >&2; usage; exit 1;;
  esac
}

main "$@"
